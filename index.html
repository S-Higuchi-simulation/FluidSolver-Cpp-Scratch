<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>1D Heat Diffusion</title>
    <style>
      body {
        margin: 0;
        background: #222;
        color: white;
      }
      canvas {
        display: block;
        margin: auto;
        background: black;
      }
    </style>
  </head>

  <body>
    <div style="text-align: center; padding: 10px">
      dt:
      <input type="number" id="dt_input" value="0.001" step="0.0001" />
    </div>

    <canvas id="canvas" width="600" height="300"></canvas>

    <script>
      var Module = {
        onRuntimeInitialized: function () {
          // --- C++ 関数ラップ ---
          const init_c = Module.cwrap("initialize_simulation_c", "void", []);
          const step_c = Module.cwrap("one_step_and_draw", "void", ["number"]);
          const getN = Module.cwrap("get_array_size", "number", []);
          const getPtr = Module.cwrap("get_temperature_data", "number", []);

          // ★ 初期化は JS から必ず呼ぶ ★
          init_c();

          const N = getN();
          const ptr = getPtr();

          const data = Module.HEAPF64.subarray(ptr / 8, ptr / 8 + N);

          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");
          const dtInput = document.getElementById("dt_input");

          function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const margin = 30;
            const scaleX = canvas.width / (N - 1);
            const scaleY = (canvas.height - 2 * margin) / 100.0;

            ctx.beginPath();
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;

            for (let i = 0; i < N; i++) {
              const x = i * scaleX;
              const y = canvas.height - margin - data[i] * scaleY;

              if (i === 0) ctx.moveTo(x, y);
              else ctx.lineTo(x, y);
            }

            ctx.stroke();
          }

          function loop() {
            const dt = parseFloat(dtInput.value);
            step_c(dt);
            draw();
            requestAnimationFrame(loop);
          }

          loop();
        },
      };
    </script>

    <script src="index.js"></script>
  </body>
</html>
